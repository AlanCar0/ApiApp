package com.example.SkinTrade.controller;

import com.example.SkinTrade.model.Usuario;
import com.example.SkinTrade.service.AuthService;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import java.util.Map;

@RestController
@RequestMapping("/api/auth")
@CrossOrigin(origins = "*") // Permite peticiones desde cualquier lado
public class AuthController {

    private final AuthService authService;

    public AuthController(AuthService authService) {
        this.authService = authService;
    }

    @PostMapping("/register")
    public ResponseEntity<?> register(
            @RequestParam("nombre") String nombre,
            @RequestParam("rut") String rut,
            @RequestParam("email") String email,
            @RequestParam("numero") String numero, // Coincide con tu React/Android
            @RequestParam("password") String password
    ) {
        try {
            Usuario newUser = authService.register(nombre, email, rut, numero, password);
            return ResponseEntity.ok(Map.of(
                "status", "success",
                "message", "Usuario registrado correctamente",
                "userId", newUser.getId()
            ));
        } catch (RuntimeException e) {
            return ResponseEntity.badRequest().body(Map.of("error", e.getMessage()));
        }
    }

    @PostMapping("/login")
    public ResponseEntity<?> login(
            @RequestParam("email") String email, 
            @RequestParam("password") String password
    ) {
        Usuario user = authService.login(email, password);
        if (user != null) {
            // Android necesita saber el ROL para decidir si ir a AdminView o HomeView
            return ResponseEntity.ok(Map.of(
                "status", "success",
                "userId", user.getId(),
                "nombre", user.getNombre(),
                "role", user.getRole() // "ADMIN" o "USER"
            ));
        } else {
            return ResponseEntity.status(401).body(Map.of("error", "Credenciales incorrectas"));
        }
    }
}